<div class="card">
  <div class="toolbar" style="justify-content:space-between;align-items:center;flex-wrap:wrap;">
    <button id="backFromMetrics" class="btn ghost">← Back</button>
    <h2 style="margin:0;">Form Metrics</h2>
  </div>

  <p>Search and filter Pantry Orders using the options below.</p>

  <div class="field-group" style="display:grid;gap:16px;margin-top:10px;">
    <!-- Quick Date Buttons -->
    <div class="field">
      <label><strong>Date:</strong></label><br>
      <div id="quickDates" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:6px;">
        <button class="quick-btn" data-range="today">Today</button>
        <button class="quick-btn" data-range="yesterday">Yesterday</button>
        <button class="quick-btn" data-range="7">Last 7 Days</button>
        <button class="quick-btn" data-range="30">Last 30 Days</button>
        <button class="quick-btn" data-range="custom">Custom</button>
      </div>
    </div>

    <!-- Custom date range -->
    <div id="customRange" style="display:none;gap:10px;align-items:center;">
      <input type="date" id="startDate" class="input-lg" />
      <span>–</span>
      <input type="date" id="endDate" class="input-lg" />
    </div>

    <!-- Status Dropdown -->
    <div class="field">
      <label><strong>Status:</strong></label><br>
      <div class="dropdown">
        <button id="statusDropdown" class="btn secondary" type="button">Select Status ▾</button>
        <div id="statusMenu" class="dropdown-menu">
          <label><input type="checkbox" value="Any" checked> Any</label>
          <label><input type="checkbox" value="Not Printed"> Not Printed</label>
          <label><input type="checkbox" value="In Progress"> In Progress</label>
          <label><input type="checkbox" value="Filled - Not Notified"> Filled - Not Notified</label>
          <label><input type="checkbox" value="Awaiting Pick-up"> Awaiting Pick-up</label>
          <label><input type="checkbox" value="Picked Up"> Picked Up</label>
          <label><input type="checkbox" value="Expired"> Expired</label>
          <label><input type="checkbox" value="Restocked"> Restocked</label>
        </div>
      </div>
    </div>

    <div class="actions" style="margin-top:10px;">
      <button id="btnSearch" class="btn">Search</button>
      <button id="btnClear" class="btn secondary">Clear</button>
    </div>
  </div>

  <!-- Spinner + message -->
  <div id="msg" class="msg" style="display:none;margin-top:12px;"></div>

  <!-- Results -->
  <div id="resultsContainer" style="display:none;margin-top:20px;overflow:auto;max-height:500px;"></div>
</div>

<style>
  .input-lg {
    padding:10px 12px;
    border-radius:10px;
    border:1px solid #cbd5e1;
    font-size:16px;
    flex:1;
    min-width:160px;
  }
  .quick-btn {
    background:#e2e8f0;
    color:#0f172a;
    border:none;
    border-radius:8px;
    padding:8px 14px;
    cursor:pointer;
    font-weight:600;
    transition:all .15s ease;
  }
  .quick-btn:hover { background:var(--accent); color:#fff; }
  .quick-btn.active { background:var(--accent); color:#fff; box-shadow:0 0 0 2px #0ea5e966 inset; }

  .dropdown { position:relative; display:inline-block; }
  .dropdown-menu {
    display:none;
    position:absolute;
    background:#fff;
    border:1px solid #cbd5e1;
    border-radius:10px;
    padding:10px;
    box-shadow:0 4px 14px rgba(0,0,0,0.1);
    z-index:10;
  }
  .dropdown-menu label {
    display:block;
    padding:4px 6px;
    font-size:16px;
    cursor:pointer;
  }
  .dropdown-menu input { margin-right:6px; }
  .dropdown.show .dropdown-menu { display:block; }

  .spinner {
    width:22px;height:22px;
    border-radius:50%;
    border:3px solid #e2e8f0;
    border-top-color:var(--accent,#0ea5e9);
    animation:spin 1s linear infinite;
    display:inline-block;
    vertical-align:middle;
    margin-right:8px;
  }
  @keyframes spin {to{transform:rotate(360deg)}}

  #resultsContainer table {
    width:100%;
    border-collapse:collapse;
  }
  #resultsContainer th, #resultsContainer td {
    padding:8px 10px;
    border-bottom:1px solid #e2e8f0;
    text-align:left;
    font-size:15px;
  }
  #resultsContainer th {
    background:#eaf2f8;
    position:sticky;
    top:0;
    z-index:1;
  }
  #resultsContainer tr:nth-child(even){background:#f8fafc;}
</style>

<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const $$ = sel => [...document.querySelectorAll(sel)];

  const quickBtns = $$('#quickDates .quick-btn');
  const customRange = $('#customRange');
  const dropdown = $('.dropdown');
  const dropdownBtn = $('#statusDropdown');
  const msg = $('#msg');
  const results = $('#resultsContainer');

  /* ===== Quick date logic ===== */
  quickBtns.forEach(btn=>{
    btn.addEventListener('click',()=>{
      quickBtns.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const val = btn.dataset.range;
      customRange.style.display = (val==='custom') ? 'flex' : 'none';
    });
  });

  /* ===== Dropdown logic ===== */
  dropdownBtn.addEventListener('click',()=> dropdown.classList.toggle('show'));
  document.addEventListener('click',e=>{
    if(!dropdown.contains(e.target)) dropdown.classList.remove('show');
  });

  function getSelectedStatuses(){
    const all = $$('#statusMenu input:checked').map(cb=>cb.value);
    return all.includes('Any') ? ['Any'] : all;
  }

  /* ===== Search button ===== */
  $('#btnSearch').addEventListener('click',()=>{
    const selectedRange = $('.quick-btn.active')?.dataset.range || '';
    const statuses = getSelectedStatuses();
    if(!selectedRange){
      setMsg('Please choose a date range first.','error');
      return;
    }

    setBusy(true, `Searching for ${statuses.join(', ')} in range ${selectedRange}…`);

    const q = {
      range: selectedRange,
      statuses,
      start: $('#startDate').value || '',
      end: $('#endDate').value || ''
    };

    google.script.run
      .withSuccessHandler(res => {
        setBusy(false);
        if (!res) { setMsg('No response from server.','error'); return; }

        // Normalize possible Apps Script return formats
        let rows = [];
        if (Array.isArray(res.rows)) rows = res.rows;
        else if (Array.isArray(res)) rows = res;
        else if (res.rows && typeof res.rows === 'object') rows = Object.values(res.rows);

        if (!rows.length) { setMsg('No results found.','error'); return; }
        renderResults(rows);
      })
      .withFailureHandler(err => {
        setBusy(false);
        setMsg('Search failed: ' + err.message, 'error');
      })
      .searchOrderMetrics(q);
  });

  /* ===== Render Results ===== */
  function renderResults(rows){
    if(!rows.length){ setMsg('No matching orders found.','error'); return; }
    results.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>Status</th><th>Date of Request</th><th>Form ID</th>
            <th>Client Name</th><th>Phone</th>
            <th>Printed</th><th>Fulfilled</th><th>Notified</th>
            <th>Picked Up</th><th>Restocked</th>
          </tr>
        </thead>
        <tbody>
          ${rows.map((r,i)=>`
            <tr>
              <td>${escapeHtml(r.status||'')}</td>
              <td>${escapeHtml(r.requestDate||'')}</td>
              <td>${escapeHtml(r.formId||'')}</td>
              <td>${escapeHtml(r.clientName||'')}</td>
              <td>${escapeHtml(r.phone||'')}</td>
              <td>${escapeHtml(r.printed||'')}</td>
              <td>${escapeHtml(r.fulfilled||'')}</td>
              <td>${escapeHtml(r.notified||'')}</td>
              <td>${escapeHtml(r.pickedUp||'')}</td>
              <td>${escapeHtml(r.restocked||'')}</td>
            </tr>`).join('')}
        </tbody>
      </table>
    `;
    results.style.display='block';
    setMsg(`${rows.length} result${rows.length>1?'s':''} found.`,'success');
  }

  /* ===== Clear ===== */
  $('#btnClear').addEventListener('click',()=>{
    quickBtns.forEach(b=>b.classList.remove('active'));
    $$('#statusMenu input').forEach(cb=>cb.checked=false);
    $('#startDate').value='';
    $('#endDate').value='';
    customRange.style.display='none';
    results.style.display='none';
    setMsg('','');
  });

  /* ===== Back ===== */
  $('#backFromMetrics').addEventListener('click',()=> showScreen('home'));

  /* ===== Helpers ===== */
  function setBusy(isBusy,text){
    if(isBusy){
      msg.innerHTML = `<span class="spinner"></span>${text||'Working…'}`;
      msg.className = 'msg info';
      msg.style.display = 'block';
    } else {
      msg.innerHTML = '';
      msg.style.display = 'none';
    }
  }
  function setMsg(html,type){
    msg.innerHTML=html||'';
    msg.className='msg '+(type||'');
    msg.style.display=html?'block':'none';
  }
  function escapeHtml(str){
    const div=document.createElement('div');
    div.innerText=str??'';
    return div.innerHTML;
  }
})();
</script>