<div class="card metrics-card">
  <div class="toolbar" style="justify-content:space-between;align-items:center;flex-wrap:wrap;">
    <button id="backFromMetrics" class="btn ghost">‚Üê Back</button>
    <h2 style="margin:0;">Form Metrics</h2>
  </div>

  <p>Search and filter Pantry Orders using the options below.</p>

  <!-- Filters -->
  <div class="filters">
    <!-- Date -->
    <div class="filter-row">
      <label class="filter-label">Date:</label>
      <div id="quickDates" class="chips">
        <button class="chip active" data-range="today">Today</button>
        <button class="chip" data-range="yesterday">Yesterday</button>
        <button class="chip" data-range="7">Last 7 Days</button>
        <button class="chip" data-range="30">Last 30 Days</button>
        <button class="chip" data-range="custom">Custom</button>
      </div>
    </div>

    <!-- Custom date range -->
    <div id="customRange" class="custom-dates" style="display:none;">
      <input type="date" id="startDate" class="input-lg" />
      <span>‚Äì</span>
      <input type="date" id="endDate" class="input-lg" />
    </div>

    <!-- Status -->
    <div class="filter-row">
      <label class="filter-label">Status:</label>
      <div id="statusBar" class="chips wrap">
        <button class="chip" data-status="Not Printed">Not Printed</button>
        <button class="chip" data-status="In Progress">In Progress</button>
        <button class="chip" data-status="Filled - Not Notified">Filled - Not Notified</button>
        <button class="chip" data-status="Awaiting Pick-up">Awaiting Pick-up</button>
        <button class="chip" data-status="Picked Up">Picked Up</button>
        <button class="chip" data-status="Expired">Expired</button>
        <button class="chip" data-status="Restocked">Restocked</button>
      </div>
    </div>

    <div class="actions">
      <button id="btnSearch" class="btn">Search</button>
      <button id="btnClear" class="btn secondary">Clear</button>
    </div>
  </div>

  <!-- Spinner / messages -->
  <div id="msg" class="msg" style="display:none;margin-top:12px;"></div>

  <!-- Results -->
  <div id="resultsWrap" style="display:none;margin-top:16px;">
    <div class="toolbar" style="justify-content:space-between;align-items:center;margin-bottom:10px;">
      <strong id="resultsCount">Results</strong>
      <button id="btnPrint" class="btn secondary" disabled>Print Results</button>
    </div>

    <div class="table-scroll">
      <table class="metrics-table">
        <thead>
          <tr>
            <th>Status</th>
            <th>Date of Request</th>
            <th>Form ID</th>
            <th>Client Name</th>
            <th>Phone</th>
            <th>Printed</th>
            <th>Fulfilled</th>
            <th>Notified</th>
            <th>Picked Up</th>
            <th>Restocked</th>
          </tr>
        </thead>
        <tbody id="resultsBody"></tbody>
      </table>
    </div>
  </div>
</div>

<style>
  /* Wider layout for desktop metrics */
  .metrics-card { padding: 20px 22px; }
  .app { width: min(1300px, 96vw) !important; }

  .filters { display:grid; gap:14px; }
  .filter-row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .filter-label { min-width:70px; font-weight:700; }

  .chips { display:flex; gap:8px; }
  .chips.wrap { flex-wrap:wrap; }
  .chip {
    background:#e2e8f0; color:#0f172a; border:none;
    border-radius:999px; padding:8px 14px; cursor:pointer; font-weight:700;
    box-shadow:0 2px 6px rgba(2,8,23,.06); transition:all .15s ease;
  }
  .chip:hover { background:var(--accent); color:#fff; }
  .chip.active { background:var(--accent); color:#fff; box-shadow:0 0 0 2px #0ea5e96b inset; }

  .custom-dates { display:flex; gap:10px; align-items:center; margin-left:80px; }
  .input-lg {
    padding:10px 12px; border-radius:10px; border:1px solid #cbd5e1;
    font-size:16px; min-width:170px;
  }
  .input-lg:focus { outline:none; box-shadow:0 0 0 2px var(--accent,#0ea5e9); }

  .spinner {
    width:22px; height:22px; border-radius:50%;
    border:3px solid #e2e8f0; border-top-color:var(--accent,#0ea5e9);
    animation:spin 1s linear infinite; display:inline-block; vertical-align:middle; margin-right:8px;
  }
  @keyframes spin {to{transform:rotate(360deg)}}

  .table-scroll {
    max-height: 360px;      /* ~10 rows visible */
    overflow: auto;
    border:1px solid #e2e8f0;
    border-radius:12px;
    background:#fff;
  }
  .metrics-table {
    width:100%;
    border-collapse:separate;
    border-spacing:0;
  }
  .metrics-table thead th {
    position:sticky; top:0; z-index:1;
    background:#eaf2f8;
    text-align:left;
    padding:10px 12px;
    font-weight:800;
    border-bottom:1px solid #dbe4ee;
  }
  .metrics-table tbody td {
    padding:10px 12px;
    border-bottom:1px solid #f1f5f9;
    white-space:nowrap;
    text-overflow:ellipsis;
    overflow:hidden;
  }
  .metrics-table tbody tr:nth-child(odd) { background:#fafcff; }
  .metrics-table tbody tr:nth-child(even) { background:#ffffff; }

  /* Print: landscape, simple table */
  @media print {
    @page { size: landscape; margin: 10mm; }
    body { background:#fff; }
    .metrics-table thead th, .metrics-table tbody td { padding:6px 8px; }
  }
</style>

<script>
(function(){
  const $  = s => document.querySelector(s);
  const $$ = s => [...document.querySelectorAll(s)];

  const msg = $('#msg');
  const resultsWrap = $('#resultsWrap');
  const resultsBody = $('#resultsBody');
  const resultsCount = $('#resultsCount');
  const btnSearch = $('#btnSearch');
  const btnClear = $('#btnClear');
  const btnPrint = $('#btnPrint');
  const quickBtns = $$('#quickDates .chip');
  const customBox = $('#customRange');

  // --- Quick date chips ---
  quickBtns.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      quickBtns.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const r = btn.dataset.range;
      customBox.style.display = (r === 'custom') ? 'flex' : 'none';
    });
  });

  // Enter triggers search for custom date inputs
  $('#startDate').addEventListener('keydown', e => { if (e.key === 'Enter') btnSearch.click(); });
  $('#endDate').addEventListener('keydown', e => { if (e.key === 'Enter') btnSearch.click(); });

  // --- Status chips (multi-select toggles) ---
  $('#statusBar').addEventListener('click', (e)=>{
    const chip = e.target.closest('.chip');
    if (!chip) return;
    chip.classList.toggle('active');
  });

  // --- Helpers ---
  function setBusy(isBusy, text){
    if (isBusy) {
      setMsg(`<span class="spinner"></span>${text || 'Working‚Ä¶'}`, '');
    } else {
      msg.innerHTML = '';
      msg.style.display = 'none';
    }
  }
  function setMsg(html, type){
    msg.innerHTML = html || '';
    msg.className = 'msg ' + (type || '');
    msg.style.display = html ? 'block' : 'none';
  }
  function activeRange(){
    const a = $('.chip[data-range].active');
    return a ? a.dataset.range : '';
  }
  function selectedStatuses(){
    const list = $$('#statusBar .chip.active').map(c => c.dataset.status);
    return list; // empty = treated as Any
  }

  // --- Phone & date formatting on the client ---
  const pad2 = n => String(n).padStart(2,'0');
  function fmtDate(any){
    if (!any) return '';
    const d = (any instanceof Date) ? any : new Date(any);
    if (isNaN(d)) return '';
    return `${pad2(d.getMonth()+1)}/${pad2(d.getDate())}/${d.getFullYear()}`;
  }
  function fmtPhone(s){
    const digits = String(s||'').replace(/\D/g,'').slice(0,10);
    if (digits.length !== 10) return String(s||'');
    return `${digits.slice(0,3)}-${digits.slice(3,6)}-${digits.slice(6)}`;
    }

  // --- Render table ---
  function renderRows(rows){
    resultsBody.innerHTML = rows.map(r=>{
      return `<tr>
        <td>${escapeHtml(r.status||'')}</td>
        <td>${escapeHtml(fmtDate(r.requestDate||r.date||''))}</td>
        <td>${escapeHtml(r.formId||'')}</td>
        <td>${escapeHtml(r.clientName||'')}</td>
        <td>${escapeHtml(fmtPhone(r.phone))}</td>
        <td>${escapeHtml(fmtDate(r.printed))}</td>
        <td>${escapeHtml(fmtDate(r.fulfilled))}</td>
        <td>${escapeHtml(fmtDate(r.notified))}</td>
        <td>${escapeHtml(fmtDate(r.pickedUp))}</td>
        <td>${escapeHtml(fmtDate(r.restocked))}</td>
      </tr>`;
    }).join('');
    resultsCount.textContent = `${rows.length} result${rows.length!==1?'s':''}`;
    resultsWrap.style.display = 'block';
    btnPrint.disabled = rows.length === 0;
  }

  // --- Search ---
  btnSearch.addEventListener('click', ()=>{
    const range = activeRange();
    if (!range) { setMsg('Please select a date range.','error'); return; }

    const q = {
      range,
      start: $('#startDate').value || '',
      end: $('#endDate').value || '',
      statuses: selectedStatuses(), // [] means Any on backend
    };

    setBusy(true, `Searching‚Ä¶`);
    google.script.run
      .withSuccessHandler(res => {
        setBusy(false);
        console.log('üîç Raw searchOrderMetrics result:', res);

        // Normalize possible response shapes
        let rows = [];
        if (!res) {
          setMsg('No response from server.', 'error');
          return;
        }

        if (Array.isArray(res.rows)) {
          rows = res.rows;
        } else if (Array.isArray(res)) {
          rows = res;
        } else if (res.rows && typeof res.rows === 'object') {
          rows = Object.values(res.rows);
        } else if (typeof res === 'object' && Object.keys(res).every(k => !isNaN(k))) {
          rows = Object.values(res);
        }

        console.log('üß© Normalized rows array:', rows);

        if (!Array.isArray(rows) || rows.length === 0) {
          setMsg('No results found.', 'error');
          resultsWrap.style.display = 'none';
          btnPrint.disabled = true;
          return;
        }

        setMsg(`${rows.length} result${rows.length !== 1 ? 's' : ''} found.`, 'success');
        renderRows(rows);
      })
      .withFailureHandler(err => {
        setBusy(false);
        setMsg(
          'Search failed: ' +
            (err && err.message ? err.message : 'Unknown error'),
          'error'
        );
        console.error('‚ùå searchOrderMetrics failed:', err);
      })
      .searchOrderMetrics(q);
  });

  // --- Clear ---
  btnClear.addEventListener('click', ()=>{
    // reset quick dates to Today
    quickBtns.forEach(b=>b.classList.remove('active'));
    quickBtns[0].classList.add('active');
    customBox.style.display = 'none';
    $('#startDate').value = '';
    $('#endDate').value = '';
    // clear statuses
    $$('#statusBar .chip.active').forEach(c=>c.classList.remove('active'));
    // clear results
    resultsWrap.style.display = 'none';
    resultsBody.innerHTML = '';
    btnPrint.disabled = true;
    setMsg('', '');
  });

  // --- Back ---
  $('#backFromMetrics').addEventListener('click', ()=> showScreen('home'));

  // --- Print ---
  btnPrint.addEventListener('click', ()=>{
    const tableHtml = `
      <html>
        <head>
          <meta charset="utf-8">
          <title>Form Metrics ‚Äî Print</title>
          <style>
            @page { size: landscape; margin: 10mm; }
            body { font:14px system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
            table { width:100%; border-collapse:collapse; }
            thead th { background:#eaf2f8; text-align:left; padding:8px; border-bottom:1px solid #dbe4ee; }
            tbody td { padding:8px; border-bottom:1px solid #f1f5f9; white-space:nowrap; }
            tbody tr:nth-child(odd){ background:#fafcff; }
          </style>
        </head>
        <body>
          <h2 style="margin:0 0 8px;">Form Metrics</h2>
          <table>
            ${$('.metrics-table').innerHTML}
          </table>
          <script>setTimeout(()=>window.print(), 250);<\/script>
        </body>
      </html>`;
    const w = window.open('', '_blank');
    w.document.write(tableHtml);
    w.document.close();
  });

  function escapeHtml(s){
    const div=document.createElement('div');
    div.innerText=String(s==null?'':s);
    return div.innerHTML;
  }
})();
if (google.script.run.ping) {
  google.script.run.withSuccessHandler(() => console.log('Metrics panel ready')).ping();
}
</script>